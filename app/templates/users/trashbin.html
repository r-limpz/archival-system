{% extends 'layout/users.html' %}
{% block title %}Trash | ARDS{% endblock %}
{% block style %}
<link href="{{url_for('static',filename='DataTables/datatables.min.css')}}" rel='stylesheet'>
<script src="{{url_for('static',filename='DataTables/datatables.min.js')}}"></script>
<link rel="stylesheet" href="{{url_for('static', filename='css/table.css')}}">
{% endblock %}

{% block content %}
<style>
    #trashbinTable_filter {
        display: none;
    }

    #trashbinTable_length {
        display: none;
    }
</style>
<section>
    <div class="page-header-title p-2 border-bottom border-1 mb-4">
        <h5 class="fw-bold">Trash</h5>
        <p class="fs-medium fst-italic"> </p>
    </div>
    <div>
        <div class="flex-grow-1" id="filtersearch_global" style="max-width: 40%;">
            <input type="text" class="form-control w-full text-truncate" id="filterSearch" placeholder="Search...">
        </div>
    </div>
    <table id='trashbinTable' class='display dataTable table-borderless table-hover fc-default' cellspacing="0"
        width="100%">
    </table>
</section>

{% endblock%}

{% block scripts %}
<script>
    var trashDataTable;

    function dataTableFunction() {
        trashDataTable = $('#trashbinTable').DataTable({
            stripeClasses: [],
            language: {
                paginate: {
                    previous: '<a class="fa-solid fa-caret-left"></a>',
                    next: '<a class="fa-solid fa-caret-right"></a>',
                }
            },
            scrollY: '60vh',
            scrollX: true,
            scrollCollapse: true,
            'processing': true,
            'responsive': true,
            'serverSide': true,
            'serverMethod': 'post',
            'ajax': {
                'url': '/trashed/documents/trashbin/files',
                'headers': { 'X-CSRFToken': '{{ csrf_token() }}' },
                'data': function (data) {
                    data.filterSearch = $('#filterSearch').val();
                }
            },
            'lengthMenu': [[25, 50, 100, -1], [25, 50, 100, "All"]],
            'deferRender': true,
            'scroller': true,
            'columns': [
                {
                    'data': 'Filename',
                    title: 'File',
                    orderable: true,
                    wrap: true,
                    className: 'text-start',
                    "render": function (data, type, row) {
                        const student_name = '<span>' + data + '</span>'
                        return `<div class="fw-medium d-flex"><span class="fa-solid fa-file-image me-4 fw-small align-self-center"></span>` + student_name + `</div>`;
                    }
                },
                { data: 'File_size', title: 'File size ', orderable: false, wrap: false, className: 'text-center', width: '100px' },
                {
                    data: 'editor',
                    title: 'Deleted by',
                    orderable: false,
                    wrap: false,
                    className: 'text-center',
                    width: '200px',
                    "render": function (data, type, row) {
                        const editor = '<span>' + data + '</span>'
                        return `<div class="fw-medium d-flex mx-auto" style="max-width:100px;"><span class="fa-solid fa-user me-3 fw-xsmall align-self-center border rounded-5 bg-red bg-light-gray" style="padding:0.25rem"></span>` + editor + `</div>`;
                    }
                },
                { data: 'Trashed', title: 'Trashed date', orderable: true, wrap: false, className: 'text-center', width: '120px' },
                { data: 'deletedOn', title: 'Delete', orderable: true, wrap: false, className: 'text-center', width: '120px' },
                {
                    'data': 'id',
                    title: ' ',
                    orderable: false,
                    wrap: true,
                    width: '80px',
                    "render": function (data, type, row) {
                        const recoverfile = `<a id="deleteThis" class="flex-fill text-center" onclick="restoreFile(` + row['id'] + `)"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="right"
                                                    data-bs-trigger="hover"
                                                    data-bs-html="true"
                                                    title="Restore">
                                                <span class="fa-solid fa-clock-rotate-left fc-default"></span>
                                            </a>`;

                        const deleteFile = `<a id="deleteThis" class="flex-fill text-center" onclick="deleteTrash(` + row['id'] + `)"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-trigger="hover"
                                                    data-bs-html="true"
                                                    title="Delete">
                                                <span class="fa-solid fa-trash text-danger"></span>
                                            </a>`;

                        return `<div class="d-flex align-items-center">` + recoverfile + '' + deleteFile + `</div>`;
                    }
                }
            ],
        });

        $('#trashbinTable tbody').on('dblclick', 'tr', function () {
            var data = trashDataTable.row(this).data();
            preview(data.image_id);
        });

        $('#filterSearch').keyup(function () {
            trashDataTable.draw();
        });
    }

    dataTableFunction();
</script>
<script>
    function preview(ImageID) {
        fetch('/trashed/documents/getDocImage/image/data/' + ImageID)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(encodedImage => {
                let previewImageDisplay = document.getElementById('previewImageDisplay');
                previewImageDisplay.src = 'data:image/jpeg;base64,' + encodedImage;

                // Show the modal
                let modal = new bootstrap.Modal(document.getElementById('showPreviewTrashFile'));
                modal.show();
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
    }

    function restoreFile(documentID) {

        let modal = new bootstrap.Modal(document.getElementById('restoreFile_confirmation'));
        modal.show();

        $('#restore_file').on('click', function (event) {
            event.preventDefault();

            var document_id = documentID; // Ensure that this variable is declared with let or const
            let formData = { 'document_id': document_id };

            $.ajax({
                url: '/trashed/documents/restore/file',
                type: 'POST',
                data: (formData),
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                success: function (data) {
                    trashDataTable.draw();
                    switch (data.recover_query) {
                        case 'success':
                            showToast('Success!', 'file resoted.', 'fc-default fa-solid fa-circle-check', 'border-dark');
                            new bootstrap.Toast(document.querySelector('#add_userToast')).show();
                            break;
                        case 'failed':
                            showToast('Error!', 'Failed to Restore file. ', 'text-warning fa-solid fa-triangle-exclamation', 'border-warning');
                            new bootstrap.Toast(document.querySelector('#add_userToast')).show();
                            break;
                    }
                },
                //handle the ajax error 
                error: function (error) {
                    console.error('Error:', error);
                    showToast('Error', 'Restore error occurred.', 'text-danger fa-solid fa-circle-exclamation', 'border-danger');
                    new bootstrap.Toast(document.querySelector('#add_userToast')).show();
                }
            });
        });
    }

    function deleteTrash(documentID) {

        let modal = new bootstrap.Modal(document.getElementById('deleteTrash_confirmation'));
        modal.show();

        $('#delete_trash').on('click', function (event) {
            event.preventDefault();

            var document_id = documentID; // Ensure that this variable is declared with let or const
            let formData = { 'document_id': document_id };

            $.ajax({
                url: '/delete/permanent/file',
                type: 'POST',
                data: (formData),
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                success: function (data) {
                    trashDataTable.draw();
                    switch (data.delete_query) {
                        case 'success':
                            showToast('Success!', 'File Deleted permanently', 'text-success fa-solid fa-circle-check', 'border-dark');
                            new bootstrap.Toast(document.querySelector('#add_userToast')).show();
                            break;
                        case 'failed':
                            showToast('Error!', 'Failed to delete file. ', 'text-warning fa-solid fa-triangle-exclamation', 'border-warning');
                            new bootstrap.Toast(document.querySelector('#add_userToast')).show();
                            break;
                    }
                },
                //handle the ajax error 
                error: function (error) {
                    console.error('Error:', error);
                    showToast('Error', 'Delete error occurred.', 'text-danger fa-solid fa-circle-exclamation', 'border-danger');
                    new bootstrap.Toast(document.querySelector('#add_userToast')).show();
                }
            });
        });
    }
</script>
{% endblock%}